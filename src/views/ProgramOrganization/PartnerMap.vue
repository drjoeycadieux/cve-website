<template>
  <div id="CNAmap"></div>
</template>

<script setup>
import "leaflet/dist/leaflet.css";
import * as L from "leaflet";
import { onMounted, computed, createApp, ref, watch } from "vue";
import { usePartnerStore } from "@/stores/partners";
import countries from "../../assets/data/countries.json";

let geoJson;
let map;

const partnerStore = usePartnerStore();
const cnaCountryCounts = partnerStore.partnerCounts.countries;
onMounted(() => {
  map = L.map("CNAmap", {
    worldCopyJump: true,
  }).setView([30, 0], 1);

  let tiles = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "",
  }).addTo(map);

  geoJson = L.geoJson(countries, {
    style: style,
    onEachFeature: onEachFeature,
  }).addTo(map);
});

function getColor(d) {
  return d > 13
    ? "#1599eb"
    : d >= 8
    ? "#f52505"
    : d >= 4
    ? "#246e3a"
    : d > 0
    ? "#8d10b3"
    : "#FFFFFF";
}

function style(feature) {
  return {
    fillColor: getColor(cnaCountryCounts[feature.properties.name]),
    weight: 2,
    opacity: 1,
    color: "white",
    dashArray: "3",
    fillOpacity: 0.7,
  };
}

function highlightFeature(e) {
  let layer = e.target;

  layer.setStyle({
    weight: 2,
    color: "#666",
    dashArray: "",
    fillOpacity: 0.5,
  });

  layer.bringToFront();
}

function resetHighlight(e) {
  geoJson.resetStyle(e.target);
}

function onEachFeature(feature, layer) {
  const popupContent = cnaCountryCounts[feature.properties.name]
    ? cnaCountryCounts[feature.properties.name]
    : 0;
  layer.bindPopup(feature.properties.name + ": " + popupContent);
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
  });
}
</script>

<style lang="scss">
@import "@/assets/style/globals.scss";
html,
body {
  margin: 0;
  padding: 0;
}

#CNAmap {
  height: 500px;
  z-index: 1;
  width: 800px;
}
</style>
