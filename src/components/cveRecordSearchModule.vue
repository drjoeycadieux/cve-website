<template>
  <div class="mt-1">
    <div v-if="websiteEnv !== 'prd'" role="alert" class="notification is-warning is-light">
      <div class="is-flex is-align-items-flex-start mt-1" style="max-width: 820px; column-gap: 1rem;">
        <div class="pl-3">
          <p id="alertIconVariousFormts" class="is-hidden">alert</p>
          <font-awesome-icon size="1x"  icon="exclamation-triangle" role="alert"
            aria-labelledby="alertIconVariousFormts" aria-hidden="false" />
        </div>
        <div class="is-flex-grow-5">
          <p class="mb-2">The <a href="https://test.cve.org">CVE Test website</a> has a new drop-down menu below.</p>
          <ol class="cve-help-text pl-4" v-if="showSearchHelpText">
            <li class="mb-2">
              <p>
                <span class="has-text-weight-bold">Search Capability (Beta) Community testers</span> – To beta-test the new search feature, select
                “<span class="has-text-weight-bold">Search CVE List (Beta)</span>” in the drop-down menu. The
                <span class="has-text-weight-bold">production</span> data is used and newly published data typically becomes searchable within less than
                30 minutes.
                <router-link to="/ResourcesSupport/FAQs#pc_cve_list_basicssearch_cve" class="cve-dark-blue-text">Access Search Tips</router-link>
                for more information on this new capability.
              </p>
              <p>
                <a href="https://forms.office.com/g/qmmTaYnr5y" target="_blank">
                  Provide feedback on the new search capability
                  <span class="icon cve-icon-xxs">
                    <p id="externalSurveyLink" class="is-hidden">
                      Survey opens in a new tab or window depending on browser settings
                    </p>
                    <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalSurveyLink" aria-hidden="false" class="ml-1"/>
                  </span>.
                </a>.
              </p>
            </li>
            <li>
              <span class="has-text-weight-bold">CNAs</span> – to view your <span class="has-text-weight-bold">test data</span>
              (your draft records) select “<span class="has-text-weight-bold">Find a Test CVE Record/ID (Legacy)</span>” in the drop-down menu and
              provide a CVE ID to find a specific CVE Record. 
            </li>
          </ol>
        </div>
        <button class="cve-button-ghost cve-btn-container mt-1" @click="showSearchHelpText = !showSearchHelpText" style="float: right !important">
          <font-awesome-icon size="1x" :icon="showSearchHelpText ? 'minus' : 'plus'" role="alert"
          aria-labelledby="alertIconVariousFormts" aria-hidden="false" />
        </button>
      </div>
    </div>
    <div class="field has-addons mt-1">
      <p class="control">
        <span v-if="websiteEnv !== 'prd'" class="select cve-search-selector">
          <select v-model="searchType">
            <option>Search CVE List (Beta)</option>
            <option>Find a Test CVE Record/ID (Legacy)</option>
          </select>
        </span>
      </p>
      <p class="control is-expanded">
        <input v-if="searchTypeBoolean" v-model.trim="queryString" @keyup.enter="onKeyUpEnter"
          @keyup="validateQueryString" type="text" class="input cve-id-input is-expanded"
          placeholder="Enter keywords (e.g.: CVE ID, sql injection, etc.)" />
        <input v-else v-model.trim="cveId" @keyup.enter="onKeyUpEnter" @keyup="validateQueryString"
          type="text" class="input cve-id-input" placeholder="Enter CVE ID (CVE-YYYY-NNNN)" />
      </p>
      <p class="control">
        <button @click="validate" class="button cve-button cve-button-accent-warm"
          :class="{ 'is-loading': cveListSearchStore.isSearching, 'disabled': cveListSearchStore.isSeachButtonDisabled }"
          :aria-disabled="cveListSearchStore.isSeachButtonDisabled">
          {{ searchTypeBoolean ? 'Search' : 'Find'}} 
        </button>
      </p>
    </div>
    <div class="notification is-warning is-light" role="alert" v-if="errorMessage.length > 0">
      <div class="is-flex is-align-content-flex-start">
        <p id="alertIcon" class="is-hidden">alert</p>
        <font-awesome-icon style="flex: 0 0 40px; margin-top:3px" size="lg" icon="exclamation-triangle" role="alert"
          aria-labelledby="alertIcon" aria-hidden="false" />
        <p class="cve-help-text">
          {{ errorMessage }}
        </p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { useCveListSearchStore } from '@/stores/cveListSearch';
import { computed, ref, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
// Legacy Search Import
import { usecveRecordStore } from '@/stores/cveRecord';
import { useGenericGlobalsStore } from '@/stores/genericGlobals';

let cveListSearchStore = useCveListSearchStore();
const route = useRoute();
const router = useRouter();

let queryString = ref('');
let errorMessage = ref('');

let cveGenericGlobalsStore = useGenericGlobalsStore();
let cveRecordStore = usecveRecordStore();
let searchType = ref('Search CVE List (Beta)');
let cveId = cveRecordStore.cveId;

let showSearchHelpText = ref(false);

// this seems redundant, but it fixes an edge case.
// if a user searches for a particular field, then on the results page flips the toggle, THEN refreshes without searching, this will keep the correct helper text showing.
let searchTypeBoolean = computed(() => {
  return searchType.value == 'Search CVE List (Beta)' ? true : false;
});

watch(searchType, () => {
  resetStates();
});

watch(
  () => route.query,
  () => {
    if (route.query?.query) {
      queryString.value = route.query.query.trim();
      validate();
    } else {
      queryString.value = cveListSearchStore.query = '';
      errorMessage.value = '';
    }
  }
)

function resetStates() {
  cveListSearchStore.searchType = cveGenericGlobalsStore.useSearch = searchTypeBoolean.value;
  cveId = '';
  queryString.value = cveListSearchStore.query = '';
  errorMessage.value = '';
  cveListSearchStore.showHelpText = false;
  cveListSearchStore.isSeachButtonDisabled = true;
}

function startSearch() {
  // We only want to flip the search item _When we actually do a search_ otherwise we should default back to what we were on a page refresh
  if (searchTypeBoolean.value) {
    cveGenericGlobalsStore.setUseSearch(true);
    cveGenericGlobalsStore.setCurrentServicesUrl(`https://${import.meta.env.VITE_CVE_SERVICES_BASE_URL}`)
  }
  else {
    cveGenericGlobalsStore.setUseSearch(false);
    cveGenericGlobalsStore.setCurrentServicesUrl(cveGenericGlobalsStore.cveServiceTestBaseUrl)
  }
  if (cveGenericGlobalsStore.useSearch) {
    if (queryString.value !== cveListSearchStore.query) {
      cveListSearchStore.$reset();
      cveListSearchStore.query = queryString.value;
      router.push({
        name: 'SearchResults',
        query: { query: cveListSearchStore.query }
      });
      cveListSearchStore.search();
    }
  } else {
    const lookupPath = `/CVERecord?id=${cveId}`;
    router.push(lookupPath)
  }
}

function validateQueryString() {
  if (searchTypeBoolean.value) {
    const alphaNumericDashPattern = new RegExp(/^[a-zA-Z0-9 ]+$/, 'i').test(queryString.value);
    const cveIdPattern = new RegExp(/^CVE-\d{4}-\d{4,7}$/, 'i').test(queryString.value);

    if (queryString.value.length > 0 && !alphaNumericDashPattern && !cveIdPattern) {
      cveListSearchStore.isSeachButtonDisabled = true;
      errorMessage.value = 'Only letters, numbers, and CVE IDs (CVE-YYYY-NNNN) are allowed.';
      cveListSearchStore.showHelpText = true;
    } else if (queryString.value.length === 0) {
      cveListSearchStore.isSeachButtonDisabled = true;
      errorMessage.value = '';
      cveListSearchStore.showHelpText = false;
    } else {
      cveListSearchStore.isSeachButtonDisabled = false;
      errorMessage.value = '';
      cveListSearchStore.showHelpText = false;
    }
  } else {
    //Basic Checking
    const cveIdPattern = new RegExp(/^CVE-\d{4}-\d{4,7}$/, 'i').test(cveId);
    if (cveId.length > 0 && !cveIdPattern) {
      cveListSearchStore.isSeachButtonDisabled = true;
      errorMessage.value = 'Required CVE ID format: CVE-YYYY-NNNN';
      cveListSearchStore.showHelpText = true;
    } else if (cveId.length === 0) {
      cveListSearchStore.isSeachButtonDisabled = true;
      errorMessage.value = '';
      cveListSearchStore.showHelpText = false;
    } else {
      cveListSearchStore.isSeachButtonDisabled = false;
      errorMessage.value = '';
      cveListSearchStore.showHelpText = false;
    }
  }
}

function onKeyUpEnter() {
  validate()
}

function validate() {

  validateQueryString();
  if (!cveListSearchStore.isSeachButtonDisabled) {
    startSearch();
  }
}

const websiteEnv = computed(() => {
  return import.meta.env.VITE_WEBSITE_ENVIRONMENT;
});
</script>

<style scoped lang="scss">
.disabled {
  opacity: 0.7 !important;
  background-color: #3d4551;
  color: white;
  border-color: #dbdbdb;
  box-shadow: none;
}

.notification {
  margin: 0 0 2px 0 !important;
  padding: 2px 10px 2px 10px !important;
}

@media screen and (min-width: $desktop) {
  .cve-id-input {
    width: 470px;
  }
}

.cve-btn-container {
  background: unset !important;
  color: $black !important;
}


.cve-btn-container:hover, .cve-inner-btn:hover {
  cursor: pointer;
  text-decoration: none !important;
}
</style>